---
title: "Finding summary keys"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{finding-summary-keys}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(brolgar)
library(ggplot2)
library(dplyr)
library(tidyr)
```

This vignette unpacks how to find interesting individuals.

Let's look at slope.

```{r l-slope}
wages_slope <- key_slope(wages_ts, ln_wages ~ xp)
```

To get the data into the right format, there are a few steps.

First, we need to get the data into a format where we have all the statistics that we are interested in, along with the id, and the statistic of interest.

Like this

```{r mutate-all-wages}
wages_slope_all_stats <- wages_slope %>%
  mutate_all(.funs = list(min = b_min,
                          max = b_max,
                          median = b_median,
                          q1 = b_q25,
                          q3 = b_q75)) %>%
  select(id,
         starts_with(".slope"))

wages_slope_all_stats
```

We then need to convert this into long format

```{r gather-wages}
wages_slope_all_stats_long <- 
wages_slope_all_stats %>%
gather(key = "stat",
         value = "stat_value",
         -id,
         -.slope_xp)

wages_slope_all_stats_long
```

We can then calculate the difference between each stat and the slope, `.slope_xp`:
```{r stats-diff}
stats_diff <- 
wages_slope_all_stats_long %>%
  mutate(stat_diff = abs(.slope_xp - stat_value))

stats_diff
```

With stats diff, we can then group by the `stat`, and find return those rows with the smallest difference between the statistic and the value:

```{r choose-top-diff}
top_stats_diff <- 
stats_diff %>%
  group_by(stat) %>%
  top_n(-1,
        wt = stat_diff)

top_stats_diff
```

```{r join-top-stats-diff}
top_stats_diff %>%
  left_join(wages, by = "id") %>%
  ggplot(aes(x = exper,
             y = lnw,
             group = id,
             colour = stat)) + 
  geom_line()
```


We can then join that back onto the data to show with gghighlight

```{r right-join-stats}
top_stats_diff %>%
  select(id, .slope_xp, stat) %>%
  right_join(wages_ts, by = "id")
```

These tranformation steps have been compacted into a summary called, `keys_near()`:

```{r use-summarise-fivenum}
wages_ts %>%
  filter_n_obs(n_obs > 3) %>%
  key_slope(formula = ln_wages ~ xp) %>%
  keys_near(key = id,
            var = .slope_xp) %>%
  left_join(wages_ts, by = "id") %>%
  ggplot(aes(x = xp,
             y = ln_wages,
             group = id,
             colour = stat)) + 
  geom_line()
```
