---
title: "Visualisation Gallery"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{visualisation-gallery}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(brolgar)
library(ggplot2)
```

`brolgar` explores two ways to explore the data, first exploring the raw data, then exploring the data using longnostics

# Exploring raw data

When you first receive your data, you want to look at as much raw data as possible. This section discusses a few techniques to make it more palatable to explore your raw data without getting too much overplotting.


## Select a sample of individuals

Sample n random individuals to explore
(Note: Possibly not representative)

For example, we can sample 20 random individuals, and then plot them. (perhaps change `sample_n_keys` into `sample_id`.)

```{r selected-sample}

wages_ts %>%
  sample_n_keys(size = 20)

wages_ts %>%
  sample_n_keys(size = 20) %>%
  ggplot(aes(x = xp,
             y = ln_wages,
             group = id)) + 
  geom_line()


```

## Filter only those with certain number of observations

We can combine this with `sample_n_keys` to filter those with at least 5 observations using `filter_n_obs`. This provides us with 20 people with at least 5 observations.

```{r filter-sample}
wages_ts %>%
  filter_n_obs(n_obs >= 5) %>%
  sample_n_keys(size = 20) %>%
  ggplot(aes(x = xp,
             y = ln_wages,
             group = id)) + 
  geom_line()
```

## Clever facets

`brolgar` provides some clever facets to help make it easier to explore your data. `facet_strata()` splits the data into 12 groups by default:

```{r facet-strata}
set.seed(2019-07-23-1936)
library(ggplot2)
ggplot(wages_ts,
       aes(x = xp,
           y = ln_wages,
           group = id)) +
  geom_line() +
  facet_strata()
```

And `facet_sample()` allows you to specify an ideal "n per plot" and "n facets". It splits the data into 12 facets with 5 per group by default:

```{r facet-sample}
set.seed(2019-07-23-1937)
ggplot(wages_ts,
       aes(x = xp,
           y = ln_wages,
           group = id)) +
  geom_line() +
  facet_sample()

```

## Create random partitions

Assign individuals to a random group 1...K.
Facet by K

About 20 lines per plot is a good number, but we might want to split this into about 6 different groups, so we can look at many at once. So now we can look at those with at least 5 observations, then sample 120 individuals, and break them into 6 groups with `stratify_keys`.

```{r filter-sample-group}

wages_ts %>%
  filter_n_obs(n_obs >= 5) %>%
  sample_n_keys(size = 120) %>%
  stratify_keys(6) %>%
  ggplot(aes(x = xp,
             y = ln_wages,
             group = id)) + 
  geom_line() + 
  facet_wrap(~.strata)

```

This allows for you to look at a larger set of the data.

However, it does not point you to those individuals who are "interesting", in the sense of those being outliers, or representative of the middle of the group.

## Highlight individuals (gghighlight)

We can find those individuals who have a negative slope using `add_key_slope`.
This adds columns `l_intercept` and `key_slope_xp`. Using the `gghighlight` library, we can identify those with an overall negative slope.

```{r wages-ts-slope}
library(dplyr)
wages_slope <- wages_ts %>%
  key_slope(ln_wages ~ xp) %>%
  left_join(wages_ts, by = "id")

library(gghighlight)

gg_wages_slope <- ggplot(wages_slope,
       aes(x = xp,
           y = ln_wages,
           group = id)) + 
  geom_line() 

gg_wages_slope + 
  gghighlight(.slope_xp < 0)

gg_wages_slope + 
  gghighlight(.slope_xp < -0.5)

```

## Combining highlighting with animation

* create a factor by cutting `key_slope` into bins
* animate over `key_slope_bins`, add information about the number of observations in each animation.

# Exploring data using features

## Scaling data

Diggle et al recommend scaling and centering data to identify features:

```{r scale-ln_wages}
library(dplyr)
wages_ts %>%
  group_by(id) %>%
  mutate(lnw_scale = scale(ln_wages)) %>%
  ungroup() %>%
  ggplot(aes(x = xp,
             y = lnw_scale,
             group = id)) + 
  geom_line()

```

## all features

```{r all-longnostic}
wages_all_features <- wages_ts %>%
  features(ln_wages,
           feat_brolgar)

wages_all_features
  
```