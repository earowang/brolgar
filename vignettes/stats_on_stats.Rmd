---
title: "Stats on Stats: Workflows with Longnostics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stats on Stats: Workflows with Longnostics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r establish-chunk-opts, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(brolgar)
```

To better understand longitudinal data we can think about some of the exploratory data analysis happening over three datasets:

1. The full data, which contain profiles of the longitudinal observations
2. The longnostics, which contain the longitudinal cognostics for each id
3. The statistics on the longnostics. These are "stats on stats" of longitudinal data.

Let's expand on this.

## The full data

We have the full set of data, which we can look at in "full spaghetti" form like so:

```{r full-spaghetti}
library(ggplot2)
ggplot(wages,
       aes(x = exper,
           y = uerate,
           group = id)) + 
  geom_line()
```

So here we have our data
```{r top-tail}
head(wages)
tail(wages)
```

## The longnostics

Now we can consider the longnostics, just say for example we are only interested in the maximum of `lnw`:

```{r wages-lnw-max}
l_max_wages <- l_max(wages, id, lnw)
```

## The statistics on longnostics

And from here we can explore the longnostics - what is the distribution of the maximum values?

```{r plot-max}
ggplot(l_max_wages,
       aes(x = l_max)) + 
  geom_density()
```

We can get the summary of these:

```{r summary-max}
summary(l_max_wages$l_max)
```

And now we want to identify those individuals who are at, or closest to the quartiles.

```{r stats-on-stats}
library(purrr)
library(tidyr)
library(dplyr)
library(brolgar)
library(glue)

l_max_wages <- l_max(wages, id, lnw)

l_max_quants <- quantile(x = l_max_wages[["l_max"]],
                         probs = c(0.25, 0.5, 0.75),
                         type = 7)

part_near <- partial(near,
                     y = l_max_wages[["l_max"]],
                     tol = 0.05)

summarise_l_max_wages <- l_max_wages %>%
  summarise(id = list(id), 
            qs = list(as.list(quantile(x = l_max,
                                       probs = c(0.25, 0.5, 0.75),
                                       type = 7)))
  )

l_max_wages_near <- summarise_l_max_wages %>%
  mutate(is_near = list(map_dfr(flatten(qs), part_near))) %>% 
  select(id, is_near) %>%
  unnest() %>%
  gather(key = "near_q",
         value = "value",
         2:4,
         -id) %>%
  mutate(quant_is_near = case_when(
    value ~ glue::glue("q_{readr::parse_number(near_q)}")
  )) %>%
  filter(!is.na(quant_is_near))

l_max_wages_near
```

```{r show-same}
wages %>%
  inner_join(l_max_wages_near, by = "id") %>%
  ggplot(aes(x = exper,
             y = lnw,
             group = id,
             colour = near_q)) + 
  geom_line() + 
  facet_wrap(~near_q)
```

```{r wages-longnostic-all}

l_wages_all <- longnostic_all(wages,
                              id = id,
                              var = lnw,
                              formula = lnw ~ exper)

l_wages_all %>%
  filter(!is.na(l_slope_exper)) %>%
  select(id, l_slope_exper) %>%
  mutate(q50 = quantile(l_slope_exper, 0.5, type = 7)) %>%
  mutate(near_q50 = near_quantile(x = l_slope_exper,
                                  probs = c(0.5),
                                  tol = 0.001)) %>%
  mutate(dist_q50 = abs(l_slope_exper - quantile(l_slope_exper, 
                                                 probs = 0.5, 
                                                 type = 7))) %>%
  arrange(dist_q50)
```
